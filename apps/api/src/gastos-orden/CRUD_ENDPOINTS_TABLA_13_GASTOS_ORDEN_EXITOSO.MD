# CRUD ENDPOINTS TABLA 13 - GASTOS_ORDEN
## ‚úÖ 100% EXITOSO - 8/8 TESTS PASADOS

**Fecha:** 2025-11-25  
**Tabla:** `gastos_orden` (Tabla 13/14 - FASE 3)  
**Estado:** ‚úÖ COMPLETO

---

## üìä RESUMEN DE TESTS

| # | Test | Endpoint | Estado |
|---|------|----------|--------|
| 1 | GET todos | `GET /api/gastos-orden` | ‚úÖ EXITOSO |
| 2 | POST crear | `POST /api/gastos-orden` | ‚úÖ EXITOSO |
| 3 | GET por ID | `GET /api/gastos-orden/:id` | ‚úÖ EXITOSO |
| 4 | GET por orden | `GET /api/gastos-orden/orden/:idOrden` | ‚úÖ EXITOSO |
| 5 | PUT actualizar | `PUT /api/gastos-orden/:id` | ‚úÖ EXITOSO |
| 6 | Validaci√≥n valor > 0 | `POST /api/gastos-orden` | ‚úÖ EXITOSO (400) |
| 7 | L√≥gica requiereAprobacion | `POST /api/gastos-orden` | ‚úÖ EXITOSO |
| 8 | DELETE eliminar | `DELETE /api/gastos-orden/:id` | ‚úÖ EXITOSO (204) |

---

## üìã ESPECIFICACI√ìN DE LA TABLA

### Campos (22 total)
| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id_gasto | SERIAL PK | ID √∫nico |
| id_orden_servicio | INT FK | Orden de servicio (CASCADE) |
| tipo_gasto | ENUM | TRANSPORTE, PARQUEADERO, PEAJE, ALIMENTACION, CONSUMIBLE, HERRAMIENTA, OTRO |
| descripcion | VARCHAR(300) | Descripci√≥n del gasto |
| justificacion | TEXT | Justificaci√≥n del gasto |
| valor | DECIMAL(12,2) | Valor del gasto (> 0) |
| tiene_comprobante | BOOLEAN | ¬øTiene comprobante? |
| numero_comprobante | VARCHAR(100) | N√∫mero de comprobante |
| proveedor | VARCHAR(200) | Nombre del proveedor |
| ruta_comprobante | VARCHAR(500) | Ruta al archivo de comprobante |
| requiere_aprobacion | BOOLEAN | Autom√°tico si valor > 100000 |
| estado_aprobacion | ENUM | PENDIENTE, APROBADO, RECHAZADO |
| observaciones_aprobacion | TEXT | Observaciones del aprobador |
| fecha_gasto | TIMESTAMP | Fecha del gasto |
| generado_por | INT FK | Empleado que genera |
| aprobado_por | INT FK | Usuario que aprueba |
| fecha_aprobacion | TIMESTAMP | Fecha de aprobaci√≥n |
| observaciones | TEXT | Observaciones generales |
| registrado_por | INT FK | Usuario que registra |
| fecha_registro | TIMESTAMP | Fecha de registro |
| modificado_por | INT FK | Usuario que modifica |
| fecha_modificacion | TIMESTAMP | Fecha de modificaci√≥n |

### ENUMs
- `tipo_gasto_enum`: TRANSPORTE, PARQUEADERO, PEAJE, ALIMENTACION, CONSUMIBLE, HERRAMIENTA, OTRO
- `estado_aprobacion_gasto_enum`: PENDIENTE, APROBADO, RECHAZADO

### Relaciones (5 FKs)
1. `ordenes_servicio` (CASCADE) - via id_orden_servicio
2. `empleados` - via generado_por
3. `usuarios` (aprobado_por) - relaci√≥n Prisma: `usuarios_gastos_orden_aprobado_porTousuarios`
4. `usuarios` (registrado_por) - relaci√≥n Prisma: `usuarios_gastos_orden_registrado_porTousuarios`
5. `usuarios` (modificado_por) - relaci√≥n Prisma: `usuarios_gastos_orden_modificado_porTousuarios`

---

## üèóÔ∏è ARQUITECTURA

### Estructura de Archivos
```
gastos-orden/
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ create-gasto-orden.dto.ts
‚îÇ   ‚îú‚îÄ‚îÄ update-gasto-orden.dto.ts
‚îÇ   ‚îî‚îÄ‚îÄ response-gasto-orden.dto.ts
‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îú‚îÄ‚îÄ commands/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-gasto-orden.command.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-gasto-orden.handler.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ update-gasto-orden.command.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ update-gasto-orden.handler.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ delete-gasto-orden.command.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ delete-gasto-orden.handler.ts
‚îÇ   ‚îú‚îÄ‚îÄ queries/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get-all-gastos-orden.query.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get-all-gastos-orden.handler.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get-gasto-orden-by-id.query.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get-gasto-orden-by-id.handler.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ get-gastos-orden-by-orden.query.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ get-gastos-orden-by-orden.handler.ts
‚îÇ   ‚îú‚îÄ‚îÄ mappers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gasto-orden.mapper.ts
‚îÇ   ‚îî‚îÄ‚îÄ enums/
‚îÇ       ‚îî‚îÄ‚îÄ tipo-gasto.enum.ts
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îî‚îÄ‚îÄ gastos-orden.repository.interface.ts
‚îú‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îî‚îÄ‚îÄ prisma-gastos-orden.repository.ts
‚îú‚îÄ‚îÄ gastos-orden.controller.ts
‚îî‚îÄ‚îÄ gastos-orden.module.ts
```

---

## üîß L√ìGICA DE NEGOCIO

### 1. Validaci√≥n valor > 0
```typescript
if (command.valor <= 0) {
  throw new BadRequestException('El valor del gasto debe ser mayor a 0');
}
```

### 2. Validaci√≥n comprobante
```typescript
if (command.tieneComprobante && !command.numeroComprobante) {
  throw new BadRequestException('Si tiene comprobante, debe proporcionar el n√∫mero de comprobante');
}
```

### 3. L√≥gica requiereAprobacion autom√°tica
```typescript
// Si valor > 100000, requiere aprobaci√≥n autom√°tica
const requiereAprobacion = command.valor > 100000;
const estadoAprobacion = requiereAprobacion ? 'PENDIENTE' : 'APROBADO';
```

---

## üì° ENDPOINTS

### POST /api/gastos-orden
Crear nuevo gasto de orden.

**Request:**
```json
{
  "idOrdenServicio": 1,
  "tipoGasto": "TRANSPORTE",
  "descripcion": "Transporte a sede cliente",
  "justificacion": "Desplazamiento para servicio en sitio",
  "valor": 45000,
  "tieneComprobante": true,
  "numeroComprobante": "FAC-2025-001",
  "proveedor": "TransServicios SAS"
}
```

**Response (201):**
```json
{
  "idGasto": 1,
  "idOrdenServicio": 1,
  "tipoGasto": "TRANSPORTE",
  "descripcion": "Transporte a sede cliente",
  "valor": 45000,
  "requiereAprobacion": false,
  "estadoAprobacion": "APROBADO",
  "ordenServicio": {
    "idOrdenServicio": 1,
    "numeroOrden": "OS-2025-001",
    "fechaProgramada": "2025-11-20T00:00:00.000Z"
  }
}
```

### GET /api/gastos-orden
Listar todos los gastos.

### GET /api/gastos-orden/:id
Obtener gasto por ID.

### GET /api/gastos-orden/orden/:idOrden
Obtener gastos de una orden de servicio espec√≠fica.

### PUT /api/gastos-orden/:id
Actualizar gasto.

### DELETE /api/gastos-orden/:id
Eliminar gasto (Hard Delete).

---

## üîç LECCIONES APRENDIDAS

1. **Campo `username` en usuarios**: El modelo `usuarios` no tiene `nombre_usuario`, usa `username`.
2. **Rutas de importaci√≥n**: PrismaModule est√° en `../database/prisma.module`, no `../prisma/prisma.module`.
3. **Nombres largos de relaciones Prisma**: Ejemplo: `usuarios_gastos_orden_aprobado_porTousuarios`.
4. **Conversi√≥n Decimal a Number**: Usar `instanceof Decimal` para convertir correctamente.

---

## ‚úÖ REGISTRO EN app.module.ts

```typescript
import { GastosOrdenModule } from './gastos-orden/gastos-orden.module';

@Module({
  imports: [
    // ...otros m√≥dulos
    GastosOrdenModule, // ‚úÖ FASE 3.13: NUEVO - Gastos Orden CQRS completo (Tabla 13/14)
  ],
})
```

---

## üìà PROGRESO FASE 3

| # | Tabla | Estado | Tests |
|---|-------|--------|-------|
| 1-9 | Various | ‚úÖ 100% | Complete |
| 10 | mediciones_servicio | üîÑ 94% | Pending |
| 11 | evidencias_fotograficas | ‚úÖ 100% | 8/8 |
| 12 | componentes_usados | ‚úÖ 100% | 8/8 |
| **13** | **gastos_orden** | ‚úÖ **100%** | **8/8** |
| 14 | Pending | ‚è∏Ô∏è | - |

---

**Generado autom√°ticamente por GitHub Copilot - Claude Opus 4.5**
