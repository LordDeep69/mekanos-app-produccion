# üìã PLANIFICACI√ìN FASE 2: USUARIOS Y AUTENTICACI√ìN

**Fecha:** 19 de Noviembre de 2025 - 9:30 PM  
**Estado:** üöÄ EN DESARROLLO  
**Prerrequisito:** ‚úÖ FASE 1 COMPLETADA AL 100% (8 Tablas - CRUD Validado)

---

## ‚ö†Ô∏è BLOQUEANTES CR√çTICOS A EVITAR (Lecciones FASE 1)

### üî¥ BLOQUEANTE #1: Servidor Detenido Durante Desarrollo

**Causa:** Ejecutar comandos en terminal donde corre el servidor  
**Prevenci√≥n:**  

- ‚úÖ Minimizar terminal del servidor (NO cerrar)
- ‚úÖ Usar terminal alternativa para todos los comandos
- ‚úÖ Verificar `netstat -ano | Select-String ":3000"` antes de cada operaci√≥n

### üî¥ BLOQUEANTE #2: Enums DTO ‚â† Base de Datos

**Causa:** DTOs con valores enum que no existen en schema.prisma  
**Prevenci√≥n:**  

- ‚úÖ SIEMPRE leer `SUPABASE.MD` o schema.prisma ANTES de crear DTOs
- ‚úÖ Copiar enums EXACTAMENTE como est√°n en la base de datos
- ‚úÖ Validar con error 400 si hay discrepancia (el error lista valores correctos)

### üî¥ BLOQUEANTE #3: Decorator @Public() Desactiva JWT

**Causa:** `@Public()` anula `JwtAuthGuard`, campos creado_por quedan NULL  
**Prevenci√≥n:**  

- ‚úÖ NO usar `@Public()` en controllers que requieren autenticaci√≥n
- ‚úÖ SIEMPRE agregar `@UseGuards(JwtAuthGuard, RolesGuard)`
- ‚úÖ SIEMPRE agregar `@CurrentUser('id') userId: number` en POST/PUT

### üî¥ BLOQUEANTE #4: Nombres de Campos DTO ‚â† Schema

**Causa:** Request body usa nombres diferentes a los definidos en Prisma  
**Prevenci√≥n:**  

- ‚úÖ Leer schema.prisma l√≠nea por l√≠nea ANTES de crear DTO
- ‚úÖ Copiar nombres de campos EXACTAMENTE como aparecen
- ‚úÖ Ejemplo: `potencia_kw` (correcto) vs `potencia_activa_kw` (incorrecto)

### üî¥ BLOQUEANTE #5: Check Constraints No Validados

**Causa:** Request body no cumple constraints de base de datos (PostgreSQL error 23514)  
**Prevenci√≥n:**  

- ‚úÖ Identificar ALL check constraints en schema ANTES de implementar
- ‚úÖ Validar en DTOs o repositorios ANTES de enviar a Prisma
- ‚úÖ Ejemplos comunes: precios, unicidad, campos mutuamente excluyentes

### üî¥ BLOQUEANTE #6: Token JWT Expirado

**Causa:** Token v√°lido por 15 minutos, desarrollo largo sin renovar  
**Prevenci√≥n:**  

- ‚úÖ Renovar token cada 10 minutos durante desarrollo
- ‚úÖ Guardar token en `$global:token` para reuso
- ‚úÖ Manejar error 401 con renovaci√≥n autom√°tica

### üî¥ BLOQUEANTE #7: Foreign Keys No Validadas

**Causa:** Intentar crear registro con FK a ID inexistente  
**Prevenci√≥n:**  

- ‚úÖ GET endpoint relacionado ANTES de POST (validar IDs existen)
- ‚úÖ Usar IDs de registros creados en FASE 1 cuando sea posible
- ‚úÖ Crear registros dependientes en orden l√≥gico (personas ‚Üí usuarios)

### üü° PR√ÅCTICA RECOMENDADA: Validaci√≥n Exhaustiva Pre-Ejecuci√≥n

**Checklist antes de cada POST:**

1. ‚úÖ Leer schema.prisma para tabla objetivo
2. ‚úÖ Identificar campos requeridos (non-nullable)
3. ‚úÖ Identificar enums y copiar valores exactos
4. ‚úÖ Identificar check constraints
5. ‚úÖ Identificar foreign keys y validar IDs
6. ‚úÖ Crear DTO con validaciones class-validator
7. ‚úÖ Verificar servidor corriendo (`netstat`)
8. ‚úÖ Verificar token v√°lido (renovar si es necesario)

---

## üéØ OBJETIVO FASE 2

Implementar el sistema completo de gesti√≥n de usuarios, roles, permisos y autenticaci√≥n JWT, integrando con las 16 tablas de la fase de usuarios.

---

## üìä ESTRUCTURA DE TABLAS FASE 2 (16 tablas)

### Grupo 1: Core Usuarios (4 tablas)

1. **personas** - Datos base de personas (f√≠sicas/jur√≠dicas)
2. **usuarios** - Cuentas de acceso al sistema
3. **empleados** - Personal de la empresa
4. **contactos_adicionales** - Contactos secundarios

### Grupo 2: Entidades Externas (3 tablas)

5. **clientes** - Empresas que contratan servicios
6. **sedes_cliente** - Ubicaciones de clientes
7. **proveedores** - Empresas que suministran productos/servicios

### Grupo 3: Certificaciones y Firmas (3 tablas)

8. **certificaciones_tecnicas** - Certificaciones de t√©cnicos
9. **firmas_administrativas** - Firmas para documentos administrativos
10. **firmas_digitales** - Firmas digitales para documentos t√©cnicos

### Grupo 4: Seguridad y Roles (6 tablas)

11. **roles** - Roles del sistema (ADMIN, TECNICO, etc.)
12. **permisos** - Permisos granulares (crear_equipo, editar_orden, etc.)
13. **roles_permiso** - Relaci√≥n N:M roles-permisos
14. **usuarios_roles** - Relaci√≥n N:M usuarios-roles
15. **tipos_enums** (compartido) - Enums para tipos de persona, identificaci√≥n, etc.
16. **sesiones_usuario** (si existe) - Control de sesiones activas

---

## üîç AN√ÅLISIS PRELIMINAR

### Tablas Ya Implementadas

- ‚úÖ **usuarios** - Ya tiene endpoint POST /api/auth/login (validado)
- ‚úÖ **roles** - Probablemente implementado parcialmente
- ‚úÖ **permisos** - Probablemente implementado parcialmente

### Tablas Por Implementar

- ‚è≠Ô∏è **personas** - Base fundamental para usuarios, empleados, clientes
- ‚è≠Ô∏è **empleados** - Extiende personas, vincula con certificaciones
- ‚è≠Ô∏è **clientes** - Gesti√≥n de clientes empresariales
- ‚è≠Ô∏è **sedes_cliente** - Ubicaciones donde hay equipos
- ‚è≠Ô∏è **proveedores** - Para √≥rdenes de compra e inventario
- ‚è≠Ô∏è **contactos_adicionales** - Personas asociadas a clientes/sedes
- ‚è≠Ô∏è **certificaciones_tecnicas** - Acreditaciones de t√©cnicos
- ‚è≠Ô∏è **firmas_administrativas** - Para cotizaciones y facturas
- ‚è≠Ô∏è **firmas_digitales** - Para informes t√©cnicos
- ‚è≠Ô∏è **roles_permiso** - Configuraci√≥n flexible de permisos
- ‚è≠Ô∏è **usuarios_roles** - Asignaci√≥n de roles a usuarios

---

## üéØ PRIORIDADES DE IMPLEMENTACI√ìN

### PRIORIDAD ALTA (Core)

1. **personas** - Tabla base, requerida por todas las entidades
2. **empleados** - Necesario para asociar usuarios con personal t√©cnico
3. **clientes** - Requerido para equipos (FK id_cliente)
4. **sedes_cliente** - Requerido para equipos (FK id_sede)

### PRIORIDAD MEDIA (Seguridad)

5. **roles_permiso** - Completar sistema de permisos
6. **usuarios_roles** - Asignaci√≥n flexible de roles
7. **contactos_adicionales** - Contactos de sedes/clientes

### PRIORIDAD BAJA (Extensiones)

8. **proveedores** - Para FASE 5 (Inventario)
9. **certificaciones_tecnicas** - Validaci√≥n de t√©cnicos
10. **firmas_administrativas** - Para cotizaciones
11. **firmas_digitales** - Para informes t√©cnicos

---

## üìù ENDPOINTS REQUERIDOS POR TABLA

### 1. Personas (PRIORIDAD ALTA)

**Modelo:**

- id_persona (PK)
- tipo_persona (ENUM: FISICA, JURIDICA)
- numero_identificacion, tipo_identificacion
- nombre_completo, nombre_comercial
- telefono, email, direccion
- activo, creado_por, fecha_creacion

**Endpoints:**

- `GET /api/personas` - Listar con filtros (tipo, activo, b√∫squeda)
- `GET /api/personas/:id` - Detalle persona
- `POST /api/personas` - Crear persona (creado_por desde JWT)
- `PUT /api/personas/:id` - Actualizar (modificado_por desde JWT)
- `DELETE /api/personas/:id` - Desactivar (soft delete)

**Relaciones:**

- 1:N con usuarios, empleados, clientes, proveedores

---

### 2. Empleados (PRIORIDAD ALTA)

**Modelo:**

- id_empleado (PK)
- id_persona (FK ‚Üí personas)
- id_usuario (FK ‚Üí usuarios, nullable)
- cargo, area
- fecha_ingreso, fecha_salida
- activo, creado_por, fecha_creacion

**Endpoints:**

- `GET /api/empleados` - Listar con filtros
- `GET /api/empleados/:id` - Detalle empleado con persona y usuario
- `POST /api/empleados` - Crear empleado
- `PUT /api/empleados/:id` - Actualizar
- `DELETE /api/empleados/:id` - Desactivar

**Casos de Uso:**

- Vincular usuario con empleado para firma de informes
- Asignar t√©cnicos a √≥rdenes de servicio
- Consultar certificaciones de t√©cnicos

---

### 3. Clientes (PRIORIDAD ALTA)

**Modelo:**

- id_cliente (PK)
- id_persona (FK ‚Üí personas)
- razon_social, nit
- sector_economico
- condiciones_pago, dias_credito
- activo, creado_por, fecha_creacion

**Endpoints:**

- `GET /api/clientes` - Listar con filtros
- `GET /api/clientes/:id` - Detalle cliente con persona y sedes
- `POST /api/clientes` - Crear cliente
- `PUT /api/clientes/:id` - Actualizar
- `DELETE /api/clientes/:id` - Desactivar

**Relaciones:**

- 1:N con sedes_cliente
- 1:N con equipos (FK: id_cliente)
- 1:N con ordenes_servicio

---

### 4. Sedes Cliente (PRIORIDAD ALTA)

**Modelo:**

- id_sede (PK)
- id_cliente (FK ‚Üí clientes)
- nombre_sede, codigo_sede
- direccion, ciudad, pais
- telefono, email_contacto
- activo, creado_por, fecha_creacion

**Endpoints:**

- `GET /api/sedes` - Listar con filtros
- `GET /api/sedes/:id` - Detalle sede
- `GET /api/clientes/:id_cliente/sedes` - Sedes de un cliente
- `POST /api/sedes` - Crear sede
- `PUT /api/sedes/:id` - Actualizar
- `DELETE /api/sedes/:id` - Desactivar

**Relaciones:**

- 1:N con equipos (FK: id_sede)
- 1:N con ordenes_servicio

---

### 5. Roles y Permisos (PRIORIDAD MEDIA)

**Modelo Roles:**

- id_rol (PK)
- codigo_rol (ej: ADMIN, TECNICO)
- nombre_rol
- descripcion
- activo

**Modelo Permisos:**

- id_permiso (PK)
- codigo_permiso (ej: equipos.crear)
- modulo (ej: EQUIPOS, ORDENES)
- accion (ej: CREATE, READ, UPDATE)
- descripcion

**Modelo Roles_Permiso:**

- id_rol (FK)
- id_permiso (FK)
- activo

**Modelo Usuarios_Roles:**

- id_usuario (FK)
- id_rol (FK)
- fecha_asignacion, fecha_revocacion
- activo

**Endpoints:**

- `GET /api/roles` - Listar roles
- `GET /api/roles/:id/permisos` - Permisos de un rol
- `POST /api/roles` - Crear rol
- `PUT /api/roles/:id` - Actualizar rol
- `POST /api/roles/:id/permisos` - Asignar permisos
- `DELETE /api/roles/:id/permisos/:id_permiso` - Revocar permiso
- `GET /api/usuarios/:id/roles` - Roles de un usuario
- `POST /api/usuarios/:id/roles` - Asignar rol
- `DELETE /api/usuarios/:id/roles/:id_rol` - Revocar rol

---

## üîê CONSIDERACIONES DE SEGURIDAD

### JWT y Autenticaci√≥n

- ‚úÖ Ya implementado en FASE 1
- Todos los endpoints POST/PUT/DELETE requieren JWT
- Campo `creado_por` extra√≠do de JWT en todos los POST
- Campo `modificado_por` extra√≠do de JWT en todos los PUT

### Guards y Decoradores

- `@UseGuards(JwtAuthGuard)` - Requerido en todos los controladores
- `@UseGuards(RolesGuard)` - Para endpoints con permisos espec√≠ficos
- `@Roles('ADMIN', 'TECNICO')` - Restricci√≥n por rol
- `@CurrentUser('id')` - Extrae userId del JWT
- **NO usar** `@Public()` - Desactiva autenticaci√≥n

### Validaciones

- DTOs con class-validator para todos los endpoints
- Enums para campos con valores predefinidos
- Unique constraints en c√≥digos y identificaciones
- Foreign keys validadas en repositorios

---

## üìã CHECKLIST DE IMPLEMENTACI√ìN

### Por cada tabla

- [ ] Crear m√≥dulo NestJS con CQRS
- [ ] Definir DTOs (create, update, query)
- [ ] Implementar comandos (crear, actualizar, eliminar)
- [ ] Implementar queries (obtener, listar)
- [ ] Crear handlers para comandos y queries
- [ ] Implementar repositorio Prisma
- [ ] Crear controlador con guards JWT
- [ ] Agregar validaciones con class-validator
- [ ] Probar POST con JWT (creado_por)
- [ ] Probar PUT con JWT (modificado_por)
- [ ] Probar GET con filtros
- [ ] Documentar en CRUD_ENDPOINTS_EXITOSOS.MD

---

## üöÄ PLAN DE EJECUCI√ìN

### Semana 1: Core Personas y Clientes

- D√≠a 1-2: Implementar tabla `personas`
- D√≠a 3-4: Implementar tabla `clientes`
- D√≠a 5: Implementar tabla `sedes_cliente`

### Semana 2: Empleados y Contactos

- D√≠a 1-2: Implementar tabla `empleados`
- D√≠a 3: Implementar tabla `contactos_adicionales`
- D√≠a 4-5: Probar integraci√≥n con equipos

### Semana 3: Roles y Permisos

- D√≠a 1-2: Completar tabla `roles_permiso`
- D√≠a 3-4: Completar tabla `usuarios_roles`
- D√≠a 5: Probar sistema de permisos end-to-end

### Semana 4: Extensiones y Validaci√≥n

- D√≠a 1: Implementar `proveedores`
- D√≠a 2: Implementar `certificaciones_tecnicas`
- D√≠a 3: Implementar `firmas_administrativas` y `firmas_digitales`
- D√≠a 4-5: Testing completo FASE 2

---

## üéØ CRITERIOS DE √âXITO FASE 2

- ‚úÖ Todas las 16 tablas implementadas
- ‚úÖ JWT funcionando en todos los endpoints
- ‚úÖ Sistema de roles y permisos operativo
- ‚úÖ Clientes y sedes vinculados con equipos
- ‚úÖ Empleados vinculados con usuarios
- ‚úÖ Documentaci√≥n completa en archivo maestro
- ‚úÖ Zero bugs cr√≠ticos pendientes

---

## üìö REFERENCIAS

- Schema SQL: `BASE_DATOS/FASE 2 - USUARIOS/*.sql`
- Patrones validados: `monorepo/CRUD_ENDPOINTS_EXITOSOS.MD`
- Bugs conocidos: Secci√≥n "BUGS CR√çTICOS RESUELTOS" en documentaci√≥n

---

**Siguiente Paso:** Iniciar implementaci√≥n de tabla `personas` como fundamento de FASE 2.
